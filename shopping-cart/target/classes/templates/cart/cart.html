<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>购物车 - 购物车系统</title>
    
    <!-- 预加载关键资源 -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" as="script">
    
    <!-- 备用CSS加载 -->
    <noscript>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    </noscript>
    
    <!-- DNS预解析 -->
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    
    <!-- 预连接到外部资源 -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <style>
        /* 关键样式 - 首屏渲染优化 */
        .cart-item {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s ease;
            will-change: box-shadow;
            transform: translateZ(0); /* 启用硬件加速 */
        }
        .cart-item:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* 页面加载动画 */
        .page-loading {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .page-loaded {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 骨架屏样式 */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .product-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        .quantity-input {
            width: 80px;
            text-align: center;
            -moz-appearance: textfield; /* Firefox */
            border: 1px solid #dee2e6;
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        .quantity-input:focus {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            box-shadow: none;
        }
        /* 隐藏Chrome、Safari、Edge等浏览器的数字输入框增减按钮 */
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .price-text {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e74c3c;
        }
        .total-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            position: sticky;
            top: 20px;
        }
        .empty-cart {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .btn-quantity {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" th:href="@{/}">
                <i class="bi bi-cart-fill me-2"></i>购物车系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/}">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/products}">商品</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item" th:if="${session.currentUser != null}">
                        <a class="nav-link active" th:href="@{/cart}">
                            <i class="bi bi-cart3"></i> 购物车
                            <span class="badge bg-warning text-dark ms-1" id="cart-count" th:text="${totalQuantity ?: 0}">0</span>
                        </a>
                    </li>
                    <li class="nav-item" th:if="${session.currentUser != null}">
                        <a class="nav-link" th:href="@{/orders}">
                            <i class="bi bi-list-ul"></i> 订单
                        </a>
                    </li>
                    <li class="nav-item" th:if="${session.currentUser != null}">
                        <a class="nav-link" th:href="@{/auth/logout}">
                            <i class="bi bi-box-arrow-right"></i> 退出
                        </a>
                    </li>
                    <li class="nav-item" th:if="${session.currentUser == null}">
                        <a class="nav-link" th:href="@{/auth/login}">
                            <i class="bi bi-box-arrow-in-right"></i> 登录
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4 page-loading" id="main-content">
        <!-- 页面标题 -->
        <div class="row mb-4">
            <div class="col">
                <h2><i class="bi bi-cart3 me-2"></i>我的购物车</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/}">首页</a></li>
                        <li class="breadcrumb-item active">购物车</li>
                    </ol>
                </nav>
            </div>
        </div>

        <!-- 错误提示 -->
        <div class="alert alert-danger alert-dismissible fade show" role="alert" th:if="${error}">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- 成功提示 -->
        <div class="alert alert-success alert-dismissible fade show" role="alert" th:if="${success}">
            <i class="bi bi-check-circle me-2"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- 购物车内容 -->
        <div class="row" th:if="${!isEmpty}">
            <!-- 购物车商品列表 -->
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>商品列表</h5>
                    <button class="btn btn-outline-danger btn-sm" onclick="clearCart()">
                        <i class="bi bi-trash"></i> 清空购物车
                    </button>
                </div>

                <div id="cart-items">
                    <div class="cart-item" th:each="item : ${cartItems}">
                        <div class="row align-items-center">
                            <!-- 商品图片 -->
                            <div class="col-md-2">
                                <img th:src="${item.product.imageUrl ?: '/images/default-product.jpg'}" 
                                     th:alt="${item.product.name}" 
                                     class="product-image">
                            </div>
                            
                            <!-- 商品信息 -->
                            <div class="col-md-4">
                                <h6 class="mb-1">
                                    <a th:href="@{/products/{id}(id=${item.product.id})}" 
                                       class="text-decoration-none" 
                                       th:text="${item.product.name}">商品名称</a>
                                </h6>
                                <p class="text-muted small mb-1" th:text="${item.product.category}">分类</p>
                                <p class="text-muted small mb-0">
                                    库存：<span th:text="${item.product.stock}">0</span>件
                                </p>
                            </div>
                            
                            <!-- 单价 -->
                            <div class="col-md-2 text-center">
                                <div class="price-text">¥<span th:text="${#numbers.formatDecimal(item.unitPrice, 1, 2)}">0.00</span></div>
                            </div>
                            
                            <!-- 数量控制 -->
                            <div class="col-md-2 text-center">
                                <div class="d-flex align-items-center justify-content-center">
                                    <button class="btn btn-outline-secondary btn-quantity me-2" 
                                            th:onclick="'decreaseQuantity(' + ${item.id} + ')'">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <input type="number" class="form-control quantity-input" 
                                           th:value="${item.quantity}" 
                                           th:id="'quantity-' + ${item.id}"
                                           min="1" 
                                           th:max="${item.product.stock}"
                                           readonly>
                                    <button class="btn btn-outline-secondary btn-quantity ms-2" 
                                            th:onclick="'increaseQuantity(' + ${item.id} + ', ' + ${item.product.stock} + ')'"
                                            th:disabled="${item.quantity >= item.product.stock}">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 小计和操作 -->
                            <div class="col-md-2 text-center">
                                <div class="price-text mb-2">¥<span th:text="${#numbers.formatDecimal(item.subtotal, 1, 2)}">0.00</span></div>
                                <button class="btn btn-outline-danger btn-sm" 
                                        th:onclick="'removeItem(' + ${item.id} + ')'">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 订单总计 -->
            <div class="col-lg-4">
                <div class="total-section">
                    <h5 class="mb-3">订单总计</h5>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>商品总数：</span>
                        <span id="total-quantity" th:text="${totalQuantity}">0</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <span>商品总价：</span>
                        <span class="price-text" id="total-amount">¥<span th:text="${#numbers.formatDecimal(totalAmount, 1, 2)}">0.00</span></span>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <strong>应付总额：</strong>
                        <strong class="price-text" id="final-amount">¥<span th:text="${#numbers.formatDecimal(totalAmount, 1, 2)}">0.00</span></strong>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a th:href="@{/orders/checkout}" class="btn btn-primary btn-lg">
                            <i class="bi bi-credit-card me-2"></i>去结算
                        </a>
                        <a th:href="@{/products}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>继续购物
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 空购物车 -->
        <div class="empty-cart" th:if="${isEmpty}">
            <i class="bi bi-cart-x" style="font-size: 4rem; color: #dee2e6;"></i>
            <h4 class="mt-3">购物车是空的</h4>
            <p>快去挑选您喜欢的商品吧！</p>
            <a th:href="@{/products}" class="btn btn-primary">
                <i class="bi bi-shop me-2"></i>去购物
            </a>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 购物车操作脚本 -->
    <script>
        // 增加商品数量
        function increaseQuantity(cartItemId, maxStock) {
            const quantityInput = document.getElementById('quantity-' + cartItemId);
            const currentQuantity = parseInt(quantityInput.value);
            
            if (currentQuantity < maxStock) {
                const newQuantity = currentQuantity + 1;
                quantityInput.value = newQuantity;
                updateQuantity(cartItemId, newQuantity);
                
                // 更新按钮状态
                const increaseBtn = quantityInput.parentElement.querySelector('.btn-quantity:last-child');
                if (newQuantity >= maxStock) {
                    increaseBtn.disabled = true;
                }
                const decreaseBtn = quantityInput.parentElement.querySelector('.btn-quantity:first-child');
                decreaseBtn.disabled = false;
            }
        }
        
        // 减少商品数量
        function decreaseQuantity(cartItemId) {
            const quantityInput = document.getElementById('quantity-' + cartItemId);
            const currentQuantity = parseInt(quantityInput.value);
            
            if (currentQuantity > 1) {
                const newQuantity = currentQuantity - 1;
                quantityInput.value = newQuantity;
                updateQuantity(cartItemId, newQuantity);
                
                // 更新按钮状态
                const increaseBtn = quantityInput.parentElement.querySelector('.btn-quantity:last-child');
                increaseBtn.disabled = false;
            } else {
                // 如果数量为1，询问是否删除商品
                if (confirm('确定要删除这个商品吗？')) {
                    removeItem(cartItemId);
                }
            }
        }
        
        // 更新商品数量
        function updateQuantity(cartItemId, quantity) {
            
            fetch('/cart/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `cartItemId=${cartItemId}&quantity=${quantity}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新页面显示
                    updateCartDisplay(data);
                    showMessage('数量已更新', 'success');
                } else {
                    showMessage(data.message || '更新失败', 'danger');
                    // 恢复原数量
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('更新失败，请稍后重试', 'danger');
                location.reload();
            });
        }
        
        // 删除商品
        function removeItem(cartItemId) {
            if (!confirm('确定要删除这个商品吗？')) {
                return;
            }
            
            fetch('/cart/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `cartItemId=${cartItemId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.isEmpty) {
                        location.reload();
                    } else {
                        // 移除商品项
                        document.querySelector(`[onclick*="${cartItemId}"]`).closest('.cart-item').remove();
                        updateCartDisplay(data);
                    }
                    showMessage('商品已删除', 'success');
                } else {
                    showMessage(data.message || '删除失败', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('删除失败，请稍后重试', 'danger');
            });
        }
        
        // 清空购物车
        function clearCart() {
            if (!confirm('确定要清空购物车吗？')) {
                return;
            }
            
            fetch('/cart/clear', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    showMessage(data.message || '清空失败', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('清空失败，请稍后重试', 'danger');
            });
        }
        
        // 更新购物车显示
        function updateCartDisplay(data) {
            if (data.totalAmount !== undefined) {
                document.getElementById('total-amount').innerHTML = '¥' + parseFloat(data.totalAmount).toFixed(2);
                document.getElementById('final-amount').innerHTML = '¥' + parseFloat(data.totalAmount).toFixed(2);
            }
            if (data.cartQuantity !== undefined) {
                document.getElementById('total-quantity').textContent = data.cartQuantity;
                document.getElementById('cart-count').textContent = data.cartQuantity;
            }
        }
        
        // 显示消息
        function showMessage(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container');
            const firstChild = container.firstElementChild;
            container.insertBefore(alertDiv, firstChild.nextElementSibling);
            
            // 3秒后自动消失
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // 页面加载优化
        document.addEventListener('DOMContentLoaded', function() {
            // 启用页面过渡动画
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                setTimeout(() => {
                    mainContent.classList.remove('page-loading');
                    mainContent.classList.add('page-loaded');
                }, 100);
            }
            
            // 预加载关键页面
            preloadCriticalPages();
            
            // 优化图片加载
            optimizeImageLoading();
        });
        
        // 预加载关键页面
        function preloadCriticalPages() {
            const criticalPages = ['/products', '/orders/checkout'];
            criticalPages.forEach(page => {
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = page;
                document.head.appendChild(link);
            });
        }
        
        // 优化图片加载
        function optimizeImageLoading() {
            const images = document.querySelectorAll('.product-image');
            images.forEach(img => {
                if (img.loading !== 'lazy') {
                    img.loading = 'lazy';
                }
                
                // 添加图片加载错误处理
                img.onerror = function() {
                    this.src = '/images/default-product.jpg';
                };
            });
        }
        
        // 防抖函数优化
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // 性能监控
        window.addEventListener('load', function() {
            // 记录页面加载时间
            const loadTime = performance.now();
            console.log(`购物车页面加载时间: ${loadTime.toFixed(2)}ms`);
            
            // 如果加载时间过长，显示提示
            if (loadTime > 3000) {
                console.warn('页面加载时间较长，建议优化');
            }
        });
    </script>
    
    <!-- 异步加载Bootstrap JS -->
    <script>
        // 异步加载Bootstrap
        const bootstrapScript = document.createElement('script');
        bootstrapScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';
        bootstrapScript.async = true;
        document.head.appendChild(bootstrapScript);
    </script>
</body>
</html>